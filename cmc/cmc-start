#!/bin/bash

NAME=cmc

export KATCP_LABEL=${NAME}-start

CONFIGVAR=${NAME^^*}_CONFIG

if [ -z "${!CONFIGVAR}" ] ; then
  export ${CONFIGVAR}=/etc/${NAME}.conf
fi

if [ -f "${!CONFIGVAR}" ] ; then
  source ${!CONFIGVAR}
else
  kcpmsg -l error "unable to locate config file ${!CONFIGVAR}"
  exit 2
fi

if [ "${state/verbose-log/}" != "${state}" ] ; then
  set -x
  #LOGFLAGS="-t -l trace"
  LOGFLAGS="-t"
else
  LOGFLAGS="-a 10"
fi

if [ "${state/tmp-log/}" != "${state}" ] ; then
  export PATH=.:${NAME}:/usr/local/bin:/usr/local/sbin:/bin:/usr/bin/
  LOGFILE=/tmp/${NAME}.kcplog
  ERRFILE=/tmp/${NAME}.log
  cd /tmp
else 
  export PATH=/usr/local/bin:/usr/local/sbin:/bin:/usr/bin/
  LOGFILE=/var/log/${NAME}.kcplog
  ERRFILE=/var/log/${NAME}.log
  cd /var/log
fi

ulimit -c unlimited

export KATCP_SERVER=localhost:${old_port}

if kcpcmd -i -t 2 watchdog >& /dev/null ; then
  kcpmsg -l error "${NAME} already running"
  exit 2
fi

sleep 0.5

if [ "$(whoami)" = "root" ] ; then
  touch ${ERRFILE}
  chown ${unprivileged_user:-nobody} ${ERRFILE}
  su ${unprivileged_user:-nobody} -c "env PATH=$PATH:/usr/local/sbin kcs -d -p ${KATCP_SERVER} -l ${ERRFILE}"
else 
  kcs -d -p ${KATCP_SERVER} -l ${ERRFILE}
fi 

timeout=10
while ! kcpcmd -i -t 2 watchdog > /dev/null ; do
  if  [ "${timeout}" -gt 0 ] ; then
    sleep 0.5
    timeout=$[timeout-1]
  else 
    kcpmsg -l error "unable to contact server"
    exit 2
  fi
done

# this is to deal with old katcp logic, new one should be different 
kcpcmd -i listener-create setup ${setup_port} 127.0.0.1 
export KATCP_SERVER=localhost:${setup_port}

# top-level katcp interface
kcpcmd -i group-create primary 
kcpcmd -i listener-create primary ${primary_port} ${bind_interface:-0.0.0.0} primary
export KATCP_SERVER=${bind_interface:-localhost}:${primary_port}

# configure top-level/primary group
kcpcmd -i scope global group primary

# logging can now be started 
kcplog ${LOGFLAGS} -d -o ${LOGFILE}

kcpcmd -i client-exec primary primary ${NAME}-primary
kcpcmd -i client-exec corr primary ${NAME}-null

# start the ntp monitor
kcpcmd -i client-exec time primary tmon
kcpcmd -i client-config client time

function kfwd()
{
  kcpcmd -i forward-symbolic $1 $2
  kcpcmd -i cmd-help $1 "$3"
}

kfwd resource-mark primary "set availability of a processing resource (?resource-mark resource marking)"
kfwd resource-list primary "show processing resources (?resource-list [resource])"
kfwd array-halt    primary "halt a subordinate (?array-halt [subordinate])"
kfwd array-list    primary "show subordinates (?array-list)"
kfwd array-assign  primary "define and launch a subordinate (?array-assign subordinates [inputs]*)"

kcpcmd -i forward-symbolic subordinate-halt    primary array-halt %1+
kcpcmd -i cmd-help         subordinate-halt   "halt an subordinate (?subordinate-halt [subordinate])"

kcpcmd -i forward-symbolic subordinate-list    primary array-list %1+
kcpcmd -i cmd-help         subordinate-list   "show running subordinates (?subordinate-list)"

kcpcmd -i forward-symbolic subordinate-create  primary array-assign %1+
kcpcmd -i cmd-help         subordinate-create "define and launch a subordinate (?subordinate-create subarray [inputs]*)"

kcpcmd -i cmd-delete halt  
kfwd halt          primary "halt the system (?halt)"

kcpcmd -i var-declare 'katcp-device*' map,version
kcpcmd -i var-set katcp-device ${device_api:-unknown} string :version
kcpcmd -i var-set katcp-device ${device_build:-unknown} string :build

kcpcmd -i var-declare "*device-status*" sensor,map
kcpcmd -i var-set "*device-status*" ok string :value
kcpcmd -i var-set "*device-status*" "correlator master controller health" string :help
kcpcmd -i var-set "*device-status*" nominal string :status
kcpcmd -i var-set "*device-status*" discrete string :type

kcpcmd -i var-set "*device-status*" ok       string ":range#0"
kcpcmd -i var-set "*device-status*" degraded string ":range#1"
kcpcmd -i var-set "*device-status*" fail     string ":range#2"

# switch back to default/setup, this will be used to clone subordinates
export KATCP_SERVER=localhost:${setup_port}

kfwd instrument-list  primary "show fielded instruments (?instrument-list)"
kfwd instrument-probe primary "check resources for an instrument (?instrument-probe instrument)"

kcpcmd -i forward-symbolic instrument-activate primary instrument-activate %g %1+
kcpcmd -i cmd-help instrument-activate "launch the specified instrument (?instrument-activate instrument)"

# might have to glue all corr-* capture-list output together 
kfwd capture-list        corr "list data products"
kfwd capture-destination corr "set data stream destination (?capture-destination stream data-destination)"
kfwd capture-start       corr "start data stream output (?capture-start stream)"
kfwd capture-stop        corr "stop data stream output (?capture-stop stream)"
kfwd capture-meta        corr "reissue stream meta-data (?capture-meta stream)"

kfwd input-labels        corr "set names of all inputs (?label inputs [name]*)"
kfwd gain                corr "set gain factors (?gain input [values])"
kfwd gain-all            corr "set gain factors (?gain-all [values])"
kfwd delays              corr "set delay and fringe correction (?delays unix-time [coefficient-set]*)"
kfwd frequency-select    corr "set the center of the frequency band (?frequency-select stream centerfrequency)"

# request by martin: inhibit accumulation length
kfwd accumulation-length corr "set the integration interval (?accumulation length period)"
#kcpcmd -i cmd-alias accumulation-length watchdog

kfwd beam-weights        corr "set the beam weigths (?beam-weights beam [values]*)"
kfwd beam-passband       corr "set the beam passband (?beam-passband beam bandwidth centerfrequency)"
kfwd beam-quant-gains    corr "set the quantiser gain for a beam (?beam-quant-gain beam [gain])"

kfwd adc-snapshot        corr "retrieve a snapshot of ADC data for a specific input (?adc-snapshot input-label [unix-time])"
kfwd transient-buffer-trigger  corr "trigger the transient buffer for all inputs (?transient-buffer-trigger)"

kfwd quantiser-snapshot  corr "retrieve quantiser data"
kfwd fft-shift           corr "set the FFT shift value (?fft-shift [value])"

kfwd digitiser-synch-epoch corr "internal synchronisation interface"
